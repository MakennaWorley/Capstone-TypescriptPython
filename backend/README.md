üß¨ Dataset Generation

How the code generates stochastic genotype data and tree sequences for ancestral inference models and dashboards.

---

## üåç Population Ancestry Dataset Outputs

These files are generated by `data_generation.py`. Unlike family-based scripts, this uses a coalescent framework to simulate deep ancestry, recombination, and mutation across a population of individuals.

### üìÇ Output Files (Family Simulation)

| File                                         | Description  | Key Contents / Columns  |
|----------------------------------------------|--------------|-------------------------|
| **`datasets/*.trees`**     | The Tree Sequence file. The gold standard for genomic data; contains the full genealogical history and ground truth. | Nodes, Edges, Sites, and Mutations. |
| **`datasets/*.truth_genotypes.csv`**      | The Ground Truth dosage matrix. Contains true genotypes for all simulated individuals at every variant site. | `site_index`, `position`, `ind_0000` to `ind_N` (values $0, 1, 2$). |
| **`datasets/*.observed_genotypes*.txt`** | The Input Data for models. A copy of the truth matrix with genotypes randomly masked (NaN) based on the `missing_rate`. |  Identical schema to truth, but contains `NaN` values. |
| **`datasets/*.sites*.txt`** | Metadata for every genetic variant discovered in the simulation. |  `site_index`, `position`, `ancestral_state`, `derived_states`. |
| **`datasets/*.sample_metadata*.txt`** | Mapping file connecting haploid sample nodes to diploid individuals. |  `sample_index`, `node_id`, `individual_index`, `hap_within_individual`. |
| **`datasets/*.run_metadata*.txt`** | Replay File. Contains every parameter and seed used. Can be fed back into the script to perfectly replicate the run. |  `params`, `derived` stats, `created_at`. |

---

### ‚öôÔ∏è How `data_generation.py` Works

This script focuses on Probabilistic Ancestral Inference. It simulates how genetic material is passed down through generations in a large population:

- **Coalescent Ancestry:** Uses `msprime.sim_ancestry` to model the stochastic "backbone" of the data (recombination and coalescence) based on effective population size ($N_e$).
- **Mutation Overlay:** Adds mutations to the tree sequence to create observable genotypes.
- **Diploid Conversion:** Converts raw haploid data into diploid dosage ($0, 1, 2$) to mimic real-world human SNP data.
- **Controlled Missingness:** Applies a random mask to the dosage matrix. This simulates low-coverage sequencing or genotyping failures, creating the "Observed" dataset.
- **Validation Logic:** If the simulation randomly produces fewer than the `--min-variants` requested, the script automatically increments the seed and retries until a sufficient dataset is generated.

---

### ‚öôÔ∏è Example Command

run `source .venv/bin/activate` to activate the python environment.

```bash
python data_generation.py \
  --prefix public \
  --n-diploid-samples 500 \
  --sequence-length 200000 \
  --mutation-rate 1e-7 \
  --missing-rate 0.20 \
  --seed 42
```

Meta Replay (Reproducibility): To recreate an exact dataset using a previous run's metadata:

```bash
python data_generation.py --meta-in my_simulations/population_run.run_metadata.json
```