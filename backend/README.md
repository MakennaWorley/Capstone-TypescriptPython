üß¨ Dataset Generation

How the code generates stochastic genotype data and tree sequences for ancestral inference models and dashboards.

---

## üåç Population Ancestry Dataset Outputs

These files are generated by `data_generation.py`. Unlike family-based scripts, this uses a coalescent framework (DTWF model) to simulate deep ancestry, recombination, and mutation across a population over specific generations.

### üìÇ Output Files (Family Simulation)

| File                                    | Description                                                                                                             | Key Contents / Columns                                              |
| --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |
| **`datasets/*.observed_genotypes.txt`** | The Input Data for models. A copy of the truth matrix with genotypes randomly masked (NaN) based on the `masking_rate`. | Identical schema to truth, but contains `NaN` values.               |
| **`datasets/*.pedigree.csv`**           | Mapping file connecting individuals to their parents and their time (generation) in the simulation.                     | `individual_id`, `time`, `parent_0_id`, `parent_1_id`, `num_nodes`. |
| **`datasets/*.pedigree.svg`**           | SVG image of the first family tree for visual inspection of the data                                                    | Dotted circles are missing data, blue circles have data.            |
| **`datasets/*.run_metadata.json`**      | Replay File. Contains every parameter and seed used. Can be fed back into the script to perfectly replicate the run.    | `params`, `derived` stats, `created_at`.                            |
| **`datasets/*.trees`**                  | The Tree Sequence file. The gold standard for genomic data; contains the full genealogical history and ground truth.    | Nodes, Edges, Sites, and Mutations.                                 |
| **`datasets/*.truth_genotypes.csv`**    | The Ground Truth dosage matrix. Contains true genotypes for all simulated individuals at every variant site.            | `site_index`, `position`, `ind_0000` to `ind_N` (values $0, 1, 2$). |

---

### ‚öôÔ∏è How `data_generation.py` Works

This script focuses on Probabilistic Ancestral Inference. It simulates how genetic material is passed down through generations in a large population:

- **Discrete Time Wright-Fisher (DTWF):** Uses the `dtwf` model to allow for explicit parent-offspring tracking across generations.
- **Mutation Overlay:** Adds mutations to the tree sequence to create observable genotypes.
- **Diploid Conversion:** Converts raw haploid data into diploid dosage ($0, 1, 2$) to mimic real-world human SNP data.
- **Controlled Missingness:** Applies a random mask to the dosage matrix. This simulates low-coverage sequencing or genotyping failures, creating the "Observed" dataset.
- **Validation Logic:** If the simulation randomly produces fewer than the `--min-variants` requested, the script automatically increments the seed and retries until a sufficient dataset is generated.
- **Generational Sampling:** Samples individuals across a fixed number of generations (default: 5) to ensure a deep pedigree is captured in the tree sequence.
- **Individual-Level Masking:** Unlike site-specific masking, this version masks the entire genotype profile of an individual to simulate cases where specific members of a population are unobserved.
- **Retry Logic:** If the mutation rate and seed result in fewer than --min-variants, the script automatically retries with a new seed.

---

### ‚öôÔ∏è Example Command

run `source .venv/bin/activate` to activate the python environment.

```bash
python data_generation.py \
  --name public \
  --n-diploid-samples 250 \
  --sequence-length 100 \
  --mutation-rate 1e-8 \
  --masking-rate 0.20 \
  --seed 21
```

Meta Replay (Reproducibility): To recreate an exact dataset using a previous run's metadata:

```bash
python data_generation.py --meta-in datasets/public.run_metadata.json
```

How to run the debugging file:

```bash
cd path/to/backend/app && python debug_genotypes.py
```

---

### üß† Understanding the Data

| Column Name        | Description                                                                                                       |
| ------------------ | ----------------------------------------------------------------------------------------------------------------- |
| **`index`**        | A unique, zero-indexed integer assigned to each variant site identified during the simulation.                    |
| **`i_0000 - i_n`** | Each column (e.g., ind_0000, ind_0001) corresponds to a single diploid individual.                                |
| **`time`**         | (In Pedigree) The generation when the individual lived. 0 is the most recent generation.                          |
| **`parent_x_id`**  | (In Pedigree) The IDs of the biological parents. Returns `-1` if the parent is outside the simulated generations. |

#### Ind_XXXX Values

Dosage Values: The numbers in these columns are genotype dosages. Because these are diploid individuals (having two sets of chromosomes), the values represent the count of the "derived" allele at that site:

- 0: Homozygous for the ancestral allele (neither chromosome has the mutation).
- 1: Heterozygous (one chromosome has the mutation, the other does not).
- 2: Homozygous for the derived allele (both chromosomes have the mutation).
- NaN: In the observed_genotypes.csv, this indicates a missing value where the data was "masked" or hidden to simulate real-world sequencing gaps.
