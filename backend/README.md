# üß¨ Dataset Generation

How the code generates the data for the models and dashboards (Streamlit and React)

---

## üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Simulation Dataset Outputs (for Imputation/Validation)

These files are generated by a separate, family-focused script (like the one you updated) to simulate parent-offspring trios and test imputation or modeling of missing parental genotypes.

### üìÇ Output Files (Family Simulation)

| File                                         | Description  | Key Columns  |
|----------------------------------------------|--------------|--------------|
| **`datasets/families_unmasked_out.csv`**     | Contains the **true, unmasked** dosage data for every individual in every family (parents and children). Used as the **Ground Truth** for validation. | `p1_dosage`, `p2_dosage`, `kid_dosage` (all $0/1/2$), `y` (true phenotype). |
| **`datasets/families_masked_out.csv`**      | The main dataset used for training/analysis. Parental dosages are intentionally removed (NaN) based on the specified mask rate. | `p1_obs`, `p2_obs` (contains $\text{NaN}$), `kid_dosage`, `y` (phenotype). |
| **`datasets/name_meta.txt`** | A text file containing all the command-line parameters used, ensuring full reproducibility.|  `seed`, `families`, `kids_per_family`, `mask_rate`, etc. |

---

### ‚öôÔ∏è How `make_msprime_families.py` Works

The family simulation script (make_msprime_families.py) differs from the main msprime cohort script (seen in the Capstone Playground or SL Final ) by focusing on parent-offspring relationships and genotype observation noise:

- **Coalescent Ancestry:** Uses `msprime` to generate founder parents for the first generation.
- **Single Trait Locus:** Unlike the polygenic score approach, it focuses on a **single risk locus** to derive the phenotype.
- **Forward-Time Pedigree:** Simulates Mendelian inheritance to generate offspring dosages from parent dosages.
- **Trait Labeling:** Labels the binary phenotype (`y`) based on the offspring's true dosage and a defined penetrance model (`dominant` or `recessive`).
- **Data Split:** The final, fully-labeled data is copied before masking.
    - The unmasked copy (containing true dosages) is saved as the validation benchmark.
    - The original copy is subjected to genotype masking (replacing true parent dosages with $\text{NaN}$ based on the `--mask-rate`) and saved as the analysis dataset.

---

### ‚öôÔ∏è Example Command

```bash
python make_msprime_families.py \
  --name families \
  --families 1000 \
  --kids-per-family 3 \
  --n-markers 4 \
  --penetrance 0.85 \
  --model dominant \
  --mask-rate 0.5 \
  --base-out trios \
  --seed 1234
```

This produces:
- `datasets/families_trio_data_unmasked_out.csv`
- `datasets/families_trio_data_masked_out.csv`
- `datasets/families_trio.txt`

example: `python make_msprime_families.py --name families --families 1000 --kids-per-family 3 --n-markers 4 --penetrance 0.85 --model dominant --mask-rate .5 --base-out trios --seed 1407461548`

---

## üå≥ Full Population Pedigree Dataset (Pedigree + Multi-Locus)

This script, combining `msprime` and a **forward-time pedigree builder**, generates a detailed dataset of individuals across multiple generations with multi-locus genotypes and a defined pedigree structure. It is designed specifically for projects involving **ancestral inference** and **imputation of missing genotypes** in pedigrees.

### üìÇ Output Files (Pedigree Simulation)

| File                                         | Description  | Key Columns  |
|----------------------------------------------|--------------|--------------|
| **`datasets/name_unmasked_out.csv`**         | **Ground Truth Data** for all individuals across all generations. Contains the **true total dosage** (sum of risk alleles across all simulated loci) for validation and analysis. | `id`, `generation`, `dosage` (true total dosage). |
| **`datasets/name_masked_out.csv`**      | The **Observed Data** containing the total dosages where individuals have been randomly masked. This file is used as the input for imputation models. | `id`, `generation`, `observed` (dosage or $\text{NaN}$), `masked` (binary flag). |
| **`datasets/name_pedigree.csv`** | The **Pedigree Structure** connecting parents and children across all generations. | `parent`, `child`. |
| **`datasets/name_genotypes.csv`** | The **Full Genotype Matrix** saved in a long format. Contains the true, unmasked dosage ($0/1/2$) for every individual at every simulated locus. | `id`, `locus_0`, `locus_1`, ..., `locus_M`. |
| **`datasets/name_meta.txt`** | A text file containing all the command-line parameters used, ensuring full reproducibility.|  `seed`, `N0`, `generations`, `mask_rate`, etc. |

---

### ‚öôÔ∏è How `simulate_population.py` Works

This pipeline builds the population structure across multiple steps:
1. Ancestry & Founders (`msprime`):
    - Uses `msprime` to simulate the genetic history of Generation 0 founders (`--N0`).
    - Applies multi-locus mutations (`--mu`) to create a large genotype matrix for the founders.
2. Genotype Extraction:
    - Extracts the founder genotypes into a diploid matrix (Genotype 0: $G_0$).
3. Forward Pedigree Building:
    - The script iteratively creates subsequent generations (`--generations`).
    - For each generation, parents are randomly paired, and offspring genotypes are simulated via **Mendelian inheritance** across all loci.
    - This process generates the pedigree.csv and the full genotypes.csv.
4. Masking:
    - A summary of the multi-locus genotype is calculated as the total `dosage` (sum of risk alleles across all loci) for every individual.
    - The `dosage` column is saved to `unmasked_out.csv`.
    - A proportion of these total dosages are randomly set to $\text{NaN}$ based on the `--mask-rate` to create the `masked_out.csv`.

---

### ‚öôÔ∏è Example Command

```bash
python simulate_population.py \
  --name full \
  --N0 500 \
  --generations 5 \
  --children 2 \
  --mask-rate 0.4 \
  --seq-len 1e6 \
  --mu 1e-7 \
  --save-trees yes \
  --seed 4567
```

This produces:
- `datasets/full_unmasked_out.csv`
- `datasets/full_masked_out.csv`
- `datasets/full_pedigree.csv`
- `datasets/full_genotypes.csv`
- `datasets/full_meta.txt`

example: `python simulate_population.py --name full --N0 50 --generations 3 --children 2 --mask-rate 0.5 --seq-len 10 --mu 1e-7 --save-trees yes --seed 2056827191`
